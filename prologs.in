#!/bin/sh

set -eu ${TRACE+-x}

usage() {
    cat <<-EOT
	Usage:
	    $0 [-h] [-k] [-O type] [-j jobs] [-p 'prolog1 prolog2 ...'] [-g goal] -- file
	
	Supported Prologs:
	    $EXP_PROLOGS
EOT
}

while getopts hp:g:kj:O: op
do
    case $op in
        p) PROLOGS="$OPTARG" ;;
        g) GOAL="$OPTARG" ;;
        k) KEEP=1 ;;
        j) JOBS="$OPTARG" ;;
        O) SYNC="$OPTARG" ;;
        h) usage; exit ;;
        ?) usage; exit 1;;
    esac
done
shift $((OPTIND - 1))
FILE=${*:-test.pl}

# PROLOGS variable is meant to be expanded to multiple arguments
# shellcheck disable=SC2086
docker run -v "$(pwd):/home/user/prolog" -it '$DOCKER_TAG' --profile "-O${SYNC-}" -f /usr/share/prologs/rules.mk "-j${JOBS:-4}" ${KEEP+-k} PROG="${FILE}" MAIN="${GOAL:-test}" ${PROLOGS:-all}
